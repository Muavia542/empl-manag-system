<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tahira CMS - Employee Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, collection, getDocs, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Constants & Configuration ---
      const DEPARTMENTS = [
          { id: '1', name: 'BS', total_employees: 18 },
          { id: '2', name: 'SOD', total_employees: 16 },
          { id: '3', name: 'Process & Inspection', total_employees: 13 },
          { id: '4', name: 'Loading Area-1', total_employees: 13 },
          { id: '5', name: 'Loading Area-2', total_employees: 13 },
      ];
      const DEFAULT_BASIC_SALARY = 36000;
      const INVOICE_DETAILS = {
          billTo: `Chief Finance Officer\nMol Pakistan Oil & Gas Co. B.V.\nIslamabad Stock Exchange Towers, Floor No 18, 55-Jinnah Avenue, Islamabad Pakistan 4400.`,
          companyNTN: '1938929-9',
          companySTRN: '701270001264',
          contractNo: 'CON1374_LOA/24',
          contractorNTN: '5194834-7',
          contractorKPGST: 'K-5194834-7',
          serviceFee: 139840,
          eobiRate: 2220,
          kpkGstRate: 0.15,
      };

      // --- Firebase Initialization and Global State ---
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_firebase_config) : {};
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
      
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let employees = [];
      let departments = [];
      let currentPage = 'dashboard';
      let editEmployee = null;
      let editDepartment = null;
      let invoiceData = null;
      let userId = null;
      let searchTerm = '';

      // --- Utility Functions ---
      const showMessage = (text, type) => {
          const messageBox = document.getElementById('message-box');
          const messageText = document.getElementById('message-text');
          messageText.textContent = text;
          messageBox.className = `fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg border-l-4 shadow-lg z-50 transition-transform ${type === 'success' ? 'bg-green-100 text-green-800 border-green-400' : 'bg-red-100 text-red-800 border-red-400'}`;
          messageBox.style.display = 'block';
          setTimeout(() => {
              messageBox.classList.add('hidden');
          }, 3000);
      };
      document.getElementById('message-close').onclick = () => {
          document.getElementById('message-box').style.display = 'none';
      };

      const renderPage = (pageName) => {
          currentPage = pageName;
          const contentArea = document.getElementById('content-area');
          contentArea.innerHTML = '';
          
          document.querySelectorAll('aside nav button').forEach(btn => {
              btn.classList.remove('bg-gray-700', 'text-white');
              btn.classList.add('hover:bg-gray-700', 'text-gray-300', 'hover:text-white');
          });
          const activeNav = document.getElementById(`nav-${pageName}`);
          if (activeNav) {
              activeNav.classList.remove('hover:bg-gray-700', 'text-gray-300', 'hover:text-white');
              activeNav.classList.add('bg-gray-700', 'text-white');
          }

          switch (pageName) {
              case 'dashboard':
                  renderDashboard();
                  break;
              case 'employees':
                  renderEmployeeList();
                  break;
              case 'departments':
                  renderDepartmentManager();
                  break;
              case 'payroll':
                  renderPayrollSummary();
                  break;
              case 'add-employee':
                  renderEmployeeForm();
                  break;
              case 'edit-employee':
                  renderEmployeeForm(editEmployee);
                  break;
              case 'add-department':
                  renderDepartmentForm();
                  break;
              case 'edit-department':
                  renderDepartmentForm(editDepartment);
                  break;
              case 'invoice-view':
                  renderInvoiceView(invoiceData);
                  break;
          }
      };

      // --- Render Functions ---
      const renderLoading = () => {
          document.getElementById('content-area').innerHTML = `
              <div class="flex justify-center items-center h-full">
                  <div class="w-12 h-12 border-4 border-t-4 border-gray-200 border-solid rounded-full animate-spin border-t-blue-500"></div>
              </div>
          `;
      };
      
      const renderDashboard = () => {
          const contentArea = document.getElementById('content-area');
          const departmentCounts = employees.reduce((acc, employee) => {
              acc[employee.department] = (acc[employee.department] || 0) + 1;
              return acc;
          }, {});
          
          const dashboardHtml = `
              <div class="p-8">
                  <h2 class="text-2xl font-semibold text-gray-800 mb-6">Dashboard</h2>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                      <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                          <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2 w-6 h-6"><path d="M14 19a6 6 0 0 0-12 0"/><circle cx="8" cy="10" r="4"/><path d="M22 19a6 6 0 0 0-12 0"/><path d="M16 10a4 4 0 0 0-.27 1.21"/></svg>
                          </div>
                          <div>
                              <p class="text-sm font-medium text-gray-500">Total Employees</p>
                              <p class="text-2xl font-semibold text-gray-900">${employees.length}</p>
                          </div>
                      </div>
                      ${departments.map(dept => `
                          <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                              <div class="p-3 bg-purple-100 text-purple-600 rounded-full">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building w-6 h-6"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9.5 12.5v-5"/><path d="M14.5 12.5v-5"/><path d="M9.5 16.5v-1"/><path d="M14.5 16.5v-1"/><path d="M9.5 19.5v-1"/><path d="M14.5 19.5v-1"/></svg>
                              </div>
                              <div>
                                  <p class="text-sm font-medium text-gray-500">${dept.name} Employees</p>
                                  <p class="text-2xl font-semibold text-gray-900">${departmentCounts[dept.name] || 0}</p>
                              </div>
                          </div>
                      `).join('')}
                  </div>
              </div>
          `;
          contentArea.innerHTML = dashboardHtml;
      };

      const renderEmployeeList = (page = 1) => {
          const contentArea = document.getElementById('content-area');
          const employeesPerPage = 10;
          const startIndex = (page - 1) * employeesPerPage;
          
          const filteredEmployees = employees.filter(emp =>
              (emp.name || '').toLowerCase().includes((searchTerm || '').toLowerCase()) ||
              (emp.department || '').toLowerCase().includes((searchTerm || '').toLowerCase()) ||
              (emp.category || '').toLowerCase().includes((searchTerm || '').toLowerCase())
          );

          const totalPages = Math.ceil(filteredEmployees.length / employeesPerPage);
          const currentEmployees = filteredEmployees.slice(startIndex, startIndex + employeesPerPage);
          
          const tableRows = currentEmployees.length > 0 ? currentEmployees.map(emp => `
              <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${emp.name}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emp.department}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emp.category}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emp.working_days}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">PKR ${(emp.total_salary || 0).toFixed(2)}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <div class="flex gap-2">
                          <button class="text-blue-600 hover:text-blue-900 transition-colors" onclick="editEmployeeHandler('${emp.id}')">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit w-5 h-5"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                          </button>
                          <button class="text-red-600 hover:text-red-900 transition-colors" onclick="deleteEmployeeHandler('${emp.id}')">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 w-5 h-5"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                          </button>
                      </div>
                  </td>
              </tr>
          `).join('') : `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No employees found.</td></tr>`;

          const paginationHtml = totalPages > 1 ? `
              <div class="flex justify-center items-center py-4 bg-gray-50">
                  <button onclick="renderEmployeeList(${page - 1})" ${page === 1 ? 'disabled' : ''} class="px-3 py-1 mx-1 rounded-md border border-gray-300 text-sm text-gray-700 bg-white hover:bg-gray-100 disabled:opacity-50">Previous</button>
                  ${Array.from({ length: totalPages }, (_, i) => `
                      <button onclick="renderEmployeeList(${i + 1})" class="px-3 py-1 mx-1 rounded-md text-sm ${page === i + 1 ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">${i + 1}</button>
                  `).join('')}
                  <button onclick="renderEmployeeList(${page + 1})" ${page === totalPages ? 'disabled' : ''} class="px-3 py-1 mx-1 rounded-md border border-gray-300 text-sm text-gray-700 bg-white hover:bg-gray-100 disabled:opacity-50">Next</button>
              </div>
          ` : '';

          contentArea.innerHTML = `
              <div class="p-8">
                  <div class="flex justify-between items-center mb-6">
                      <h2 class="text-2xl font-semibold text-gray-800">Employee List</h2>
                      <div class="flex gap-4">
                          <input type="file" accept=".csv" id="csv-upload" class="hidden" onchange="importCSV(event)"/>
                          <label for="csv-upload" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-colors cursor-pointer">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload w-5 h-5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                              Import CSV
                          </label>
                          <button id="add-employee-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus w-5 h-5"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                              Add Employee
                          </button>
                      </div>
                  </div>
                  <div class="mb-4">
                      <input type="text" placeholder="Search employees..." class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" value="${searchTerm}" oninput="searchEmployees(event)">
                  </div>
                  <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                      <div class="overflow-x-auto">
                          <table class="min-w-full divide-y divide-gray-200">
                              <thead class="bg-gray-50">
                                  <tr>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Working Days</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Salary</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                  </tr>
                              </thead>
                              <tbody class="bg-white divide-y divide-gray-200">
                                  ${tableRows}
                              </tbody>
                          </table>
                      </div>
                      ${paginationHtml}
                  </div>
              </div>
          `;
          document.getElementById('add-employee-btn').onclick = () => {
            editEmployee = null;
            renderPage('add-employee');
          };
      };

      const renderDepartmentManager = () => {
          const contentArea = document.getElementById('content-area');
          const departmentTableRows = departments.length > 0 ? departments.map(dept => `
              <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dept.name}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dept.total_employees}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <div class="flex gap-2">
                          <button class="text-blue-600 hover:text-blue-900 transition-colors" onclick="editDepartmentHandler('${dept.id}')">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit w-5 h-5"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                          </button>
                          <button class="text-red-600 hover:text-red-900 transition-colors" onclick="deleteDepartmentHandler('${dept.id}')">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 w-5 h-5"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                          </button>
                      </div>
                  </td>
              </tr>
          `).join('') : `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No departments found.</td></tr>`;

          contentArea.innerHTML = `
              <div class="p-8">
                  <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Departments</h2>
                  <div class="flex flex-col md:flex-row gap-8">
                      <div class="md:w-1/3 bg-white p-6 rounded-xl shadow-lg h-min">
                          <h3 class="text-lg font-semibold text-gray-800 mb-4">Add New Department</h3>
                          <form id="department-form">
                              <div class="flex flex-col mb-4">
                                  <label for="name" class="text-gray-600 font-medium mb-1">Department Name</label>
                                  <input type="text" id="name" name="name" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                              </div>
                              <div class="flex flex-col mb-4">
                                  <label for="total_employees" class="text-gray-600 font-medium mb-1">Total Employees</label>
                                  <input type="number" id="total_employees" name="total_employees" value="0" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                              </div>
                              <div class="flex gap-4">
                                  <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 transition-colors w-full">Add Department</button>
                              </div>
                          </form>
                      </div>

                      <div class="md:w-2/3 bg-white rounded-xl shadow-lg p-6">
                          <h3 class="text-lg font-semibold text-gray-800 mb-4">Current Departments</h3>
                          <div class="overflow-x-auto">
                              <table class="min-w-full divide-y divide-gray-200">
                                  <thead class="bg-gray-50">
                                      <tr>
                                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Employees</th>
                                          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                      </tr>
                                  </thead>
                                  <tbody class="bg-white divide-y divide-gray-200">
                                      ${departmentTableRows}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>
          `;
          document.getElementById('department-form').onsubmit = handleAddOrUpdateDepartment;
      };

      const renderPayrollSummary = () => {
          const contentArea = document.getElementById('content-area');
          const totalSalaryUnskilled = employees
              .filter(e => e.category === 'Unskilled')
              .reduce((sum, e) => sum + e.total_salary, 0);
          const totalSalarySkilled = employees
              .filter(e => e.category === 'Skilled')
              .reduce((sum, e) => sum + e.total_salary, 0);
          const grandTotalSalary = totalSalaryUnskilled + totalSalarySkilled;
          
          contentArea.innerHTML = `
              <div class="p-8">
                  <h2 class="text-2xl font-semibold text-gray-800 mb-6">Payroll Summary</h2>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                          <div class="p-3 bg-indigo-100 text-indigo-600 rounded-full">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet w-6 h-6"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h12a2 2 0 0 1 0 4H5a2 2 0 0 1 0 4h12a2 2 0 0 0 2-2v-2"/><path d="M6 12H20"/><path d="M12 17h6"/></svg>
                          </div>
                          <div>
                              <p class="text-sm font-medium text-gray-500">Total Unskilled Salary</p>
                              <p class="text-2xl font-semibold text-gray-900">PKR ${totalSalaryUnskilled.toLocaleString()}</p>
                          </div>
                      </div>
                      <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                          <div class="p-3 bg-teal-100 text-teal-600 rounded-full">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wand-2 w-6 h-6"><path d="m21.37 2.63-1.88 1.88"/><path d="M17.12 6.88 15.25 8.75"/><path d="M19.14 11.23a2.53 2.53 0 0 1-3.6 3.6L5.3 5.3a2.53 2.53 0 0 1 3.6-3.6L19.14 11.23z"/><path d="M2 22l.46-1.54"/><path d="m11.5 13.5-1.54.46"/></svg>
                          </div>
                          <div>
                              <p class="text-sm font-medium text-gray-500">Total Skilled Salary</p>
                              <p class="text-2xl font-semibold text-gray-900">PKR ${totalSalarySkilled.toLocaleString()}</p>
                          </div>
                      </div>
                      <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                          <div class="p-3 bg-rose-100 text-rose-600 rounded-full">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign w-6 h-6"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                          </div>
                          <div>
                              <p class="text-sm font-medium text-gray-500">Grand Total Salary</p>
                              <p class="text-2xl font-semibold text-gray-900">PKR ${grandTotalSalary.toLocaleString()}</p>
                          </div>
                      </div>
                  </div>
              </div>
          `;
      };

      const renderEmployeeForm = (employee = null) => {
          editEmployee = employee;
          const contentArea = document.getElementById('content-area');
          const isEdit = !!employee;
          const departmentOptions = departments.map(dept => `<option value="${dept.name}" ${employee?.department === dept.name ? 'selected' : ''}>${dept.name}</option>`).join('');

          contentArea.innerHTML = `
              <div class="p-8">
                  <h2 class="text-2xl font-semibold text-gray-800 mb-6">${isEdit ? 'Edit Employee' : 'Add Employee'}</h2>
                  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl mx-auto">
                      <form id="employee-form">
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <div class="flex flex-col">
                                  <label for="name" class="text-gray-600 font-medium mb-1">Name</label>
                                  <input type="text" id="name" name="name" value="${employee?.name || ''}" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                              </div>
                              <div class="flex flex-col">
                                  <label for="department" class="text-gray-600 font-medium mb-1">Department</label>
                                  <select id="department" name="department" class="px-4 py-2 rounded-lg border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                      ${departmentOptions}
                                  </select>
                              </div>
                              <div class="flex flex-col">
                                  <label for="category" class="text-gray-600 font-medium mb-1">Category</label>
                                  <select id="category" name="category" class="px-4 py-2 rounded-lg border border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                      <option value="Skilled" ${employee?.category === 'Skilled' ? 'selected' : ''}>Skilled</option>
                                      <option value="Unskilled" ${employee?.category === 'Unskilled' ? 'selected' : ''}>Unskilled</option>
                                  </select>
                              </div>
                              <div class="flex flex-col">
                                  <label for="basic_salary" class="text-gray-600 font-medium mb-1">Basic Salary (PKR)</label>
                                  <input type="number" id="basic_salary" name="basic_salary" value="${employee?.basic_salary || DEFAULT_BASIC_SALARY}" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                              </div>
                              <div class="flex flex-col">
                                  <label for="working_days" class="text-gray-600 font-medium mb-1">Working Days</label>
                                  <input type="number" id="working_days" name="working_days" value="${employee?.working_days || 0}" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                              </div>
                          </div>
                          <div class="flex justify-end gap-4 mt-8">
                              <button type="button" onclick="renderPage('employees')" class="px-6 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors">Cancel</button>
                              <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 transition-colors">
                                  ${isEdit ? 'Save Changes' : 'Add Employee'}
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          `;
          document.getElementById('employee-form').onsubmit = handleAddOrUpdateEmployee;
      };

      const renderDepartmentForm = (department = null) => {
          editDepartment = department;
          const contentArea = document.getElementById('content-area');
          const isEdit = !!department;

          contentArea.innerHTML = `
              <div class="p-8">
                  <h2 class="text-2xl font-semibold text-gray-800 mb-6">${isEdit ? 'Edit Department' : 'Add New Department'}</h2>
                  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl mx-auto">
                      <form id="department-form">
                          <div class="flex flex-col mb-4">
                              <label for="name" class="text-gray-600 font-medium mb-1">Department Name</label>
                              <input type="text" id="name" name="name" value="${department?.name || ''}" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                          </div>
                          <div class="flex flex-col mb-4">
                              <label for="total_employees" class="text-gray-600 font-medium mb-1">Total Employees</label>
                              <input type="number" id="total_employees" name="total_employees" value="${department?.total_employees || 0}" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                          </div>
                          <div class="flex justify-end gap-4 mt-8">
                              <button type="button" onclick="renderPage('departments')" class="px-6 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors">Cancel</button>
                              <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-semibold shadow-md hover:bg-blue-700 transition-colors">
                                  ${isEdit ? 'Save Changes' : 'Add Department'}
                              </button>
                          </div>
                      </form>
                  </div>
              </div>
          `;
          document.getElementById('department-form').onsubmit = handleAddOrUpdateDepartment;
      };

      const renderInvoiceView = (data) => {
          invoiceData = data;
          if (!data) {
              showMessage('No invoice data to display. Generate one first.', 'error');
              return;
          }
          const contentArea = document.getElementById('content-area');
          const itemsHtml = data.items.map(item => `
              <tr>
                  <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${item.description}</td>
                  <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${item.rate}</td>
                  <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${item.attendance}</td>
                  <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${item.pob}</td>
                  <td class="border border-gray-300 px-4 py-2 text-right text-sm text-gray-800">${item.amount}</td>
              </tr>
          `).join('');

          contentArea.innerHTML = `
              <div class="p-8">
                  <div class="flex justify-between items-center mb-6">
                      <h2 class="text-2xl font-semibold text-gray-800">Invoice</h2>
                      <div class="flex gap-4">
                          <button onclick="renderPage('employees')" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 transition-colors">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left w-5 h-5"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                              Back
                          </button>
                          <button id="export-pdf-btn" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file w-5 h-5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/></svg>
                              Export as PDF
                          </button>
                      </div>
                  </div>
                  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl mx-auto" id="invoice-content">
                      <div class="flex justify-between mb-8">
                          <div>
                              <h3 class="text-xl font-bold text-gray-800">Tahira Construction & Services</h3>
                              <p class="text-sm text-gray-500">KPK Sales Tax Invoice</p>
                          </div>
                          <div class="text-right">
                              <h4 class="text-sm text-gray-600">Invoice No: <span class="font-semibold text-gray-800">${data.invoiceNo}</span></h4>
                              <h4 class="text-sm text-gray-600">Date: <span class="font-semibold text-gray-800">${data.date}</span></h4>
                              <h4 class="text-sm text-gray-600">Contract No: <span class="font-semibold text-gray-800">${INVOICE_DETAILS.contractNo}</span></h4>
                          </div>
                      </div>
                      <div class="mb-8">
                          <h4 class="text-sm font-semibold text-gray-600">Bill To:</h4>
                          <p class="text-sm text-gray-800 whitespace-pre-wrap">${INVOICE_DETAILS.billTo}</p>
                          <p class="text-sm text-gray-800">NTN #: <span class="font-semibold">${INVOICE_DETAILS.companyNTN}</span> | STRN: <span class="font-semibold">${INVOICE_DETAILS.companySTRN}</span></p>
                          <p class="text-sm text-gray-800">NTN (Contractor) #: <span class="font-semibold">${INVOICE_DETAILS.contractorNTN}</span></p>
                          <p class="text-sm text-gray-800">KPK GST #: <span class="font-semibold">${INVOICE_DETAILS.contractorKPGST}</span></p>
                      </div>
                      <div class="mb-8">
                          <p class="font-semibold text-lg text-gray-800">Invoice For Month: ${data.month}</p>
                          <p class="text-gray-600 text-sm">Provision of Support Services Logistics and Billing Operation Dept</p>
                      </div>
                      <div class="overflow-x-auto">
                          <table class="min-w-full border-collapse border border-gray-300">
                              <thead>
                                  <tr class="bg-gray-100">
                                      <th class="border border-gray-300 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Description/Location</th>
                                      <th class="border border-gray-300 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Rate</th>
                                      <th class="border border-gray-300 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Attendance</th>
                                      <th class="border border-gray-300 px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">POB</th>
                                      <th class="border border-gray-300 px-4 py-2 text-right text-xs font-semibold text-gray-600 uppercase">Amount</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${itemsHtml}
                                  <tr>
                                      <td colspan="4" class="border border-gray-300 px-4 py-2 text-right font-semibold text-gray-800">Sub Total</td>
                                      <td class="border border-gray-300 px-4 py-2 text-right text-gray-800">${data.subTotal}</td>
                                  </tr>
                                  <tr>
                                      <td colspan="4" class="border border-gray-300 px-4 py-2 text-right font-semibold text-gray-800">EOBI (PKR ${data.eobi.rate})</td>
                                      <td class="border border-gray-300 px-4 py-2 text-right text-gray-800">${data.eobi.amount}</td>
                                  </tr>
                                  <tr class="bg-gray-50">
                                      <td colspan="4" class="border border-gray-300 px-4 py-2 text-right font-bold text-gray-900">Total Sum</td>
                                      <td class="border border-gray-300 px-4 py-2 text-right font-bold text-gray-900">${data.totalSum}</td>
                                  </tr>
                                  <tr>
                                      <td colspan="4" class="border border-gray-300 px-4 py-2 text-right font-semibold text-gray-800">Add KPK GST @15%</td>
                                      <td class="border border-gray-300 px-4 py-2 text-right text-gray-800">${data.kpkGst}</td>
                                  </tr>
                                  <tr class="bg-blue-100">
                                      <td colspan="4" class="border border-gray-300 px-4 py-2 text-right font-bold text-lg text-blue-800">TOTAL AMOUNT (PKR)</td>
                                      <td class="border border-gray-300 px-4 py-2 text-right font-bold text-lg text-blue-800">${data.totalAmount.toLocaleString()}</td>
                                  </tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          `;
          document.getElementById('export-pdf-btn').onclick = generatePDF;
      };

      const renderPayrollSummary = () => {
          const contentArea = document.getElementById('content-area');
          const totalSalaryUnskilled = employees
              .filter(e => e.category === 'Unskilled')
              .reduce((sum, e) => sum + e.total_salary, 0);
          const totalSalarySkilled = employees
              .filter(e => e.category === 'Skilled')
              .reduce((sum, e) => sum + e.total_salary, 0);
          const grandTotalSalary = totalSalaryUnskilled + totalSalarySkilled;
          
          contentArea.innerHTML = `
              <div class="p-8">
                  <h2 class="text-2xl font-semibold text-gray-800 mb-6">Payroll Summary</h2>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                          <div class="p-3 bg-indigo-100 text-indigo-600 rounded-full">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet w-6 h-6"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h12a2 2 0 0 1 0 4H5a2 2 0 0 1 0 4h12a2 2 0 0 0 2-2v-2"/><path d="M6 12H20"/><path d="M12 17h6"/></svg>
                          </div>
                          <div>
                              <p class="text-sm font-medium text-gray-500">Total Unskilled Salary</p>
                              <p class="text-2xl font-semibold text-gray-900">PKR ${totalSalaryUnskilled.toLocaleString()}</p>
                          </div>
                      </div>
                      <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                          <div class="p-3 bg-teal-100 text-teal-600 rounded-full">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wand-2 w-6 h-6"><path d="m21.37 2.63-1.88 1.88"/><path d="M17.12 6.88 15.25 8.75"/><path d="M19.14 11.23a2.53 2.53 0 0 1-3.6 3.6L5.3 5.3a2.53 2.53 0 0 1 3.6-3.6L19.14 11.23z"/><path d="M2 22l.46-1.54"/><path d="m11.5 13.5-1.54.46"/></svg>
                          </div>
                          <div>
                              <p class="text-sm font-medium text-gray-500">Total Skilled Salary</p>
                              <p class="text-2xl font-semibold text-gray-900">PKR ${totalSalarySkilled.toLocaleString()}</p>
                          </div>
                      </div>
                      <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-4">
                          <div class="p-3 bg-rose-100 text-rose-600 rounded-full">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign w-6 h-6"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                          </div>
                          <div>
                              <p class="text-sm font-medium text-gray-500">Grand Total Salary</p>
                              <p class="text-2xl font-semibold text-gray-900">PKR ${grandTotalSalary.toLocaleString()}</p>
                          </div>
                      </div>
                  </div>
              </div>
          `;
      };
      
      const renderLoginPage = () => {
          document.body.innerHTML = `
            <div class="flex flex-col items-center justify-center min-h-screen w-full bg-gray-100">
                <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-md text-center">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Employee Management System</h1>
                    <p class="text-gray-600 mb-8">Please wait while we log you in securely.</p>
                    <div class="w-12 h-12 border-4 border-t-4 border-gray-200 border-solid rounded-full animate-spin border-t-blue-500 mx-auto"></div>
                </div>
            </div>
          `;
      }

      // --- Firebase Data Operations ---
      const fetchAllData = async () => {
          renderLoading();
          
          try {
              // Fetch Departments
              const departmentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'departments');
              const departmentSnapshot = await getDocs(departmentsRef);
              departments = departmentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

              // If no departments exist, initialize them.
              if (departments.length === 0) {
                  for (const dept of DEPARTMENTS) {
                      await setDoc(doc(departmentsRef, dept.name), dept);
                  }
                  const updatedDepts = await getDocs(query(departmentsRef));
                  departments = updatedDepts.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              }

              // Set up real-time listener for employees
              const employeesRef = collection(db, 'artifacts', appId, 'users', userId, 'employees');
              onSnapshot(employeesRef, (snapshot) => {
                  employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  renderPage(currentPage);
              }, (error) => {
                  console.error("Error fetching employees:", error);
                  showMessage('Failed to load employee data.', 'error');
              });

          } catch (e) {
              console.error("Error fetching data:", e);
              showMessage('Failed to connect to backend services.', 'error');
          }
      };

      // --- CRUD Operations ---
      const handleAddOrUpdateEmployee = async (e) => {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);
          const newEmployee = {
              name: formData.get('name'),
              department: formData.get('department'),
              category: formData.get('category'),
              basic_salary: parseFloat(formData.get('basic_salary') || DEFAULT_BASIC_SALARY),
              working_days: parseInt(formData.get('working_days'), 10) || 0,
              created_at: new Date().toISOString(),
          };
          newEmployee.total_salary = (newEmployee.basic_salary / 22) * newEmployee.working_days;

          try {
              const employeesRef = collection(db, 'artifacts', appId, 'users', userId, 'employees');
              if (editEmployee) {
                  await updateDoc(doc(employeesRef, editEmployee.id), newEmployee);
                  showMessage('Employee updated successfully!', 'success');
              } else {
                  await addDoc(employeesRef, newEmployee);
                  showMessage('Employee added successfully!', 'success');
              }
              renderPage('employees');
          } catch (e) {
              console.error("Error adding/updating employee:", e);
              showMessage('Failed to save employee data.', 'error');
          }
      };

      const deleteEmployeeHandler = async (id) => {
          if (window.confirm('Are you sure you want to delete this employee?')) {
              try {
                  const employeeDocRef = doc(db, 'artifacts', appId, 'users', userId, 'employees', id);
                  await deleteDoc(employeeDocRef);
                  showMessage('Employee deleted successfully!', 'success');
              } catch (e) {
                  console.error("Error deleting employee:", e);
                  showMessage('Failed to delete employee.', 'error');
              }
          }
      };
      
      const handleAddOrUpdateDepartment = async (e) => {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);
          const newDepartment = {
              name: formData.get('name'),
              total_employees: parseInt(formData.get('total_employees'), 10),
          };

          try {
              const departmentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'departments');
              if (editDepartment) {
                  await updateDoc(doc(departmentsRef, editDepartment.id), newDepartment);
                  showMessage('Department updated successfully!', 'success');
              } else {
                  await addDoc(departmentsRef, newDepartment);
                  showMessage('Department added successfully!', 'success');
              }
              renderPage('departments');
          } catch (e) {
              console.error("Error adding/updating department:", e);
              showMessage('Failed to save department data.', 'error');
          }
      };

      const deleteDepartmentHandler = async (id) => {
          if (window.confirm('Are you sure you want to delete this department?')) {
              try {
                  const departmentDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'departments', id);
                  await deleteDoc(departmentDocRef);
                  showMessage('Department deleted successfully!', 'success');
              } catch (e) {
                  console.error("Error deleting department:", e);
                  showMessage('Failed to delete department.', 'error');
              }
          }
      };

      const editEmployeeHandler = (id) => {
          editEmployee = employees.find(emp => emp.id === id);
          renderPage('edit-employee');
      };

      const editDepartmentHandler = (id) => {
          editDepartment = departments.find(dept => dept.id === id);
          renderPage('edit-department');
      };

      const importCSV = (event) => {
          const file = event.target.files[0];
          if (!file) return;

          Papa.parse(file, {
              header: true,
              skipEmptyLines: true,
              complete: async (results) => {
                  const employeesToImport = results.data.map(emp => {
                      const newEmp = {
                          name: emp.Name || '',
                          department: emp.Department || '',
                          category: emp.Category || 'Unskilled',
                          basic_salary: parseFloat(emp['Basic Salary']) || DEFAULT_BASIC_SALARY,
                          working_days: parseInt(emp['Working Days'], 10) || 0,
                          created_at: new Date().toISOString(),
                      };
                      newEmp.total_salary = (newEmp.basic_salary / 22) * newEmp.working_days;
                      return newEmp;
                  });

                  try {
                      const employeesRef = collection(db, 'artifacts', appId, 'users', userId, 'employees');
                      for (const employee of employeesToImport) {
                          await addDoc(employeesRef, employee);
                      }
                      showMessage(`Successfully imported ${employeesToImport.length} employees.`, 'success');
                      renderPage('employees');
                  } catch (e) {
                      console.error("Error importing employees:", e);
                      showMessage('Failed to import employees.', 'error');
                  }
              },
              error: (error) => {
                  showMessage('Error parsing CSV file. Please check format.', 'error');
              }
          });
      };

      const generateInvoice = () => {
          const unskilledLabors = employees.filter(emp => emp.category === 'Unskilled');
          const unskilledAttendance = unskilledLabors.reduce((sum, emp) => sum + (emp.working_days || 0), 0);
          const unskilledPob = unskilledLabors.length;
          const unskilledRate = unskilledLabors.length > 0 ? unskilledLabors[0].basic_salary / 22 : 0;
          const unskilledAmount = unskilledLabors.reduce((sum, emp) => sum + (emp.total_salary || 0), 0);
          
          const serviceFeeAmount = INVOICE_DETAILS.serviceFee;
          const subTotal = unskilledAmount + serviceFeeAmount;
          const eobiAmount = INVOICE_DETAILS.eobiRate * unskilledPob;
          const totalSum = subTotal + eobiAmount;
          const kpkGst = totalSum * INVOICE_DETAILS.kpkGstRate;
          const totalAmount = totalSum + kpkGst;
          
          invoiceData = {
              invoiceNo: `TCS-${Math.floor(Math.random() * 1000) + 1}`,
              date: new Date().toLocaleDateString('en-PK'),
              month: new Date().toLocaleString('default', { month: 'long', year: 'numeric' }),
              items: [
                  { description: 'Unskilled Labors', rate: unskilledRate.toFixed(2), attendance: unskilledAttendance, pob: unskilledPob, amount: unskilledAmount.toFixed(2) },
                  { description: 'Service Fee', rate: '-', attendance: '-', pob: '-', amount: serviceFeeAmount.toFixed(2) },
              ],
              subTotal: subTotal.toFixed(2),
              eobi: { rate: INVOICE_DETAILS.eobiRate.toFixed(2), pob: unskilledPob, amount: eobiAmount.toFixed(2) },
              totalSum: totalSum.toFixed(2),
              kpkGst: kpkGst.toFixed(2),
              totalAmount: Math.round(totalAmount),
          };
          renderInvoiceView(invoiceData);
      };

      const generatePDF = async () => {
          const data = invoiceData;
          if (!data) return;
          const pdfDoc = await PDFLib.PDFDocument.create();
          const page = pdfDoc.addPage();
          const { width, height } = page.getSize();
          const fontSize = 12;
          let y = height - 50;
          const margin = 50;

          const drawText = (text, x, y, options = {}) => {
              page.drawText(text, { x, y, size: fontSize, font: options.font, color: PDFLib.rgb(0, 0, 0), ...options });
          };

          drawText('KPK Sales Tax Invoice', { x: width - 200, y: y, size: 16 });
          y -= 30;
          drawText(`Bill To:\n${INVOICE_DETAILS.billTo}\nNTN # ${INVOICE_DETAILS.companyNTN} | STRN: ${INVOICE_DETAILS.companySTRN}`, { x: margin, y: y, lineHeight: 1.5 });
          y -= 60;
          drawText(`Invoice #: ${data.invoiceNo}`, { x: margin, y: y });
          y -= 20;
          drawText(`Date: ${data.date}`, { x: margin, y: y });
          y -= 20;
          drawText(`Contract #: ${INVOICE_DETAILS.contractNo}`, { x: margin, y: y });
          y -= 20;
          drawText(`Invoice For Month: ${data.month}`, { x: margin, y: y });
          y -= 40;

          const tableHeaders = ['Description/Location', 'Rate', 'Attendance', 'POB', 'Amount'];
          const colWidths = [150, 80, 80, 50, 100];
          let currentX = margin;
          tableHeaders.forEach((header, i) => {
              drawText(header, { x: currentX, y: y, size: 10 });
              currentX += colWidths[i];
          });
          y -= 20;

          data.items.forEach(item => {
              currentX = margin;
              drawText(item.description, { x: currentX, y: y, size: 10 });
              currentX += colWidths[0];
              drawText(item.rate.toString(), { x: currentX, y: y, size: 10 });
              currentX += colWidths[1];
              drawText(item.attendance.toString(), { x: currentX, y: y, size: 10 });
              currentX += colWidths[2];
              drawText(item.pob.toString(), { x: currentX, y: y, size: 10 });
              currentX += colWidths[3];
              drawText(item.amount.toString(), { x: currentX, y: y, size: 10 });
              y -= 20;
          });

          y -= 10;
          drawText(`Sub Total`, { x: margin + colWidths[0], y: y, size: 10 });
          drawText(data.subTotal, { x: margin + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y: y, size: 10 });
          y -= 20;
          drawText(`EOBI (${data.eobi.rate})`, { x: margin + colWidths[0], y: y, size: 10 });
          drawText(data.eobi.amount, { x: margin + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y: y, size: 10 });
          y -= 20;
          drawText(`Total Sum`, { x: margin + colWidths[0], y: y, size: 10 });
          drawText(data.totalSum, { x: margin + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y: y, size: 10 });
          y -= 20;
          drawText(`Add KPK GST @15%`, { x: margin + colWidths[0], y: y, size: 10 });
          drawText(data.kpkGst, { x: margin + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y: y, size: 10 });
          y -= 20;
          drawText(`TOTAL AMOUNT (PKR)`, { x: margin + colWidths[0], y: y, size: 12, font: 'Helvetica-Bold' });
          drawText(data.totalAmount.toLocaleString(), { x: margin + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3], y: y, size: 12, font: 'Helvetica-Bold' });

          const pdfBytes = await pdfDoc.save();
          const blob = new Blob([pdfBytes], { type: 'application/pdf' });
          saveAs(blob, `Invoice-${data.invoiceNo}.pdf`);
          showMessage('PDF generated successfully!', 'success');
      };

      let searchTerm = ''; // Declare searchTerm globally
      const searchEmployees = (event) => {
          searchTerm = event.target.value;
          renderPage('employees');
      };
      
      // --- Initial Load and Event Listeners ---
      document.addEventListener('DOMContentLoaded', () => {
          renderLoginPage();
          onAuthStateChanged(auth, async (user) => {
              if (user) {
                  userId = user.uid;
                  document.body.innerHTML = document.documentElement.outerHTML;
                  document.getElementById('user-id').querySelector('span').textContent = `User ID: ${userId}`;
                  await fetchAllData();
                  renderPage('dashboard');

                  document.getElementById('nav-dashboard').onclick = () => renderPage('dashboard');
                  document.getElementById('nav-employees').onclick = () => renderPage('employees');
                  document.getElementById('nav-departments').onclick = () => renderPage('departments');
                  document.getElementById('nav-payroll').onclick = () => renderPage('payroll');
                  document.getElementById('nav-invoice').onclick = generateInvoice;
              } else {
                  if (initialAuthToken) {
                      await signInWithCustomToken(auth, initialAuthToken);
                  } else {
                      await signInAnonymously(auth);
                  }
              }
          });
      });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex text-gray-900">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 text-white flex-shrink-0 flex flex-col p-4 shadow-lg rounded-r-2xl">
        <div class="flex items-center gap-3 p-4 border-b border-gray-700 mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building-2 text-blue-400 w-8 h-8"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18"/><path d="M6 12H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>
            <span class="text-xl font-bold">Tahira CMS</span>
        </div>
        <nav class="flex-1">
            <ul>
                <li class="mb-2">
                    <button id="nav-dashboard" class="flex items-center gap-3 w-full px-4 py-2 rounded-lg transition-colors bg-gray-700 text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard w-5 h-5"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                        Dashboard
                    </button>
                </li>
                <li class="mb-2">
                    <button id="nav-employees" class="flex items-center gap-3 w-full px-4 py-2 rounded-lg transition-colors hover:bg-gray-700 text-gray-300 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users w-5 h-5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Employees
                    </button>
                </li>
                <li class="mb-2">
                    <button id="nav-departments" class="flex items-center gap-3 w-full px-4 py-2 rounded-lg transition-colors hover:bg-gray-700 text-gray-300 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-building w-5 h-5"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9.5 12.5v-5"/><path d="M14.5 12.5v-5"/><path d="M9.5 16.5v-1"/><path d="M14.5 16.5v-1"/><path d="M9.5 19.5v-1"/><path d="M14.5 19.5v-1"/></svg>
                        Departments
                    </button>
                </li>
                <li class="mb-2">
                    <button id="nav-payroll" class="flex items-center gap-3 w-full px-4 py-2 rounded-lg transition-colors hover:bg-gray-700 text-gray-300 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet w-5 h-5"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h12a2 2 0 0 1 0 4H5a2 2 0 0 1 0 4h12a2 2 0 0 0 2-2v-2"/><path d="M6 12H20"/><path d="M12 17h6"/></svg>
                        Payroll
                    </button>
                </li>
                <li class="mb-2">
                    <button id="nav-invoice" class="flex items-center gap-3 w-full px-4 py-2 rounded-lg transition-colors hover:bg-gray-700 text-gray-300 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text w-5 h-5"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M16 11H8"/><path d="M16 16H8"/><path d="M12 21H8"/></svg>
                        Generate Invoice
                    </button>
                </li>
            </ul>
        </nav>
        <div class="border-t border-gray-700 pt-4 mt-auto">
            <button id="user-id" class="flex items-center gap-3 w-full px-4 py-2 rounded-lg text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user w-5 h-5"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="truncate">User ID: Loading...</span>
            </button>
        </div>
    </aside>
    
    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col p-6">
        <h1 class="text-4xl font-bold text-gray-800 mb-8">Employee Management</h1>
        <div id="content-area" class="flex-1 rounded-3xl p-6 bg-white shadow-lg overflow-auto">
            <!-- Content will be injected here -->
        </div>
    </main>

    <!-- Message Box -->
    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg border-l-4 shadow-lg z-50 transition-transform hidden">
        <p id="message-text" class="font-semibold"></p>
        <button id="message-close" class="absolute top-1 right-2 text-xl font-bold">&times;</button>
    </div>
</body>
</html>
